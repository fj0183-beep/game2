<style> /* æ¶ˆé™¤ç¶²é é è¨­é‚Šè· */ html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; /* é˜²æ­¢å‡ºç¾æ²è»¸ */ } /* å‡è¨­ä½ çš„éŠæˆ²ç•«å¸ƒæˆ–å®¹å™¨ ID æ˜¯ gameCanvas */ #gameCanvas { width: 100vw; height: 100vh; object-fit: contain; /* ä¿æŒæ¯”ä¾‹ç¸®æ”¾ */ display: block; } </style>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è…åˆ©äººç”Ÿ - è¶…ç´šèŒè¡›æ•™å°å¹«æ‰‹</title>
   
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
       
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(180deg, #fffcf0 0%, #fff1f2 100%);
            color: #475569;
            user-select: none;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.2s ease;
        }

        /* èƒŒæ™¯è£é£¾ */
        .bg-decoration {
            position: fixed;
            top: -5%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(254, 215, 170, 0.4) 0%, transparent 70%);
            z-index: -1;
        }

        /* Qå½ˆé£„æµ®å‹•ç•« */
        @keyframes floatingMega {
            0% { transform: translateY(0px) scale(1, 1); }
            50% { transform: translateY(-35px) scale(1.04, 0.96); }
            100% { transform: translateY(0px) scale(1, 1); }
        }
        .animate-floating-mega {
            animation: floatingMega 4s ease-in-out infinite;
        }

        /* é‡åŠ›éœ‡å‹•å‹•ç•« (ç­”éŒ¯ç”¨) */
        @keyframes shake-heavy {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-15px); }
            20%, 40%, 60%, 80% { transform: translateX(15px); }
        }
        .animate-heavy-shake {
            animation: shake-heavy 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* æ‹›æ‰‹å‹•ç•« */
        @keyframes wavingHand {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-30deg); }
        }
        .hand-wave {
            transform-origin: 35px 35px;
            animation: wavingHand 1s ease-in-out infinite;
        }

        .soft-card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 3.5rem;
            border: 6px solid #ffffff;
            box-shadow: 0 20px 50px -15px rgba(251, 146, 60, 0.2);
            backdrop-filter: blur(10px);
        }

        .main-headline {
            font-size: 3.2rem;
            font-weight: 900;
            line-height: 1.1;
            color: #1e293b;
            letter-spacing: -0.02em;
        }

        .btn-speech-red {
            background: #ffffff;
            border: 12px solid #fb7185;
            border-radius: 4.5rem;
            padding: 2.2rem 1.5rem;
            color: #e11d48;
            font-weight: 900;
            font-size: 2.4rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 15px 40px rgba(225, 29, 72, 0.25);
        }
        .btn-speech-red:active { transform: scale(0.96); border-color: #f43f5e; }

        .menu-grid-btn {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2.8rem;
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.02);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 4px solid #ffffff;
            padding: 1rem;
        }
        .menu-grid-btn:active { transform: scale(0.92); }
        .menu-grid-btn span {
            margin-top: 1.25rem;
            font-weight: 900;
            color: #475569;
            font-size: 1.2rem;
        }

        .btn-choice {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2.2rem;
            background: #ffffff;
            text-align: left;
            padding: 1.4rem 1.5rem;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            border: 3px solid #f8fafc;
        }
       
        .option-marker {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
            font-weight: 900;
            font-size: 1.4rem;
            box-shadow: 0 5px 12px rgba(0,0,0,0.06);
        }

        .btn-wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
        .btn-correct { background-color: #ecfdf5 !important; border-color: #22c55e !important; color: #065f46 !important; }
        .flash-red-bg { background-color: #ef4444 !important; }

        .modal-show { animation: slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100px); } to { opacity: 1; transform: translateY(0); } }

        .chart-container { position: relative; width: 100%; max-width: 280px; margin: 0 auto; height: 220px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="bg-decoration"></div>

    <nav class="sticky top-0 z-50 px-6 py-6 flex justify-between items-center bg-white/40 backdrop-blur-md border-b border-orange-100 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="bg-rose-400 p-2 rounded-2xl text-white shadow-md">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            </div>
            <div>
                <h1 class="font-black text-slate-800 text-xl tracking-tight leading-none">è…åˆ©äººç”Ÿ</h1>
                <p class="text-[10px] text-rose-500 font-black tracking-widest mt-1 uppercase italic">Care & Play</p>
            </div>
        </div>
        <div id="nav-badge" class="hidden">
            <span class="bg-rose-500 text-white text-[10px] px-3 py-1 rounded-full font-black animate-pulse italic">éŠæˆ²ä¸­</span>
        </div>
    </nav>

    <main id="app-root" class="flex-grow p-6 max-w-md mx-auto w-full flex flex-col justify-center">
        <!-- å‹•æ…‹æ¸²æŸ“ -->
    </main>

    <footer class="p-10 text-center text-slate-400">
        <p class="text-sm font-bold tracking-widest opacity-60 italic leading-relaxed">æ±æ­¢åœ‹æ³°é†«é™¢æ´—è…å®¤<br>å°ˆæ¥­åœ˜éšŠå®ˆè­·æ‚¨çš„å¥åº·</p>
    </footer>

    <script>
        // --- æ ¸å¿ƒèªéŸ³ï¼š1.55 å€æ¥µé€Ÿå°è®€ ---
        function speakChat(text, mood = 'normal') {
            if (!state.audioUnlocked) return;
            window.speechSynthesis.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-TW';
            utter.rate = 1.55;  
            utter.pitch = mood === 'excited' ? 1.1 : 0.95;
            window.speechSynthesis.speak(utter);
        }

        // --- è³ªæ„Ÿç¹ªåœ–åº« (SVG) ---
        const illustrations = {
            kidney_mega: `<svg viewBox="0 0 240 240" class="w-full max-w-[320px] h-auto animate-floating-mega mx-auto">
                <defs><radialGradient id="gradK" cx="50%" cy="50%" r="50%"><stop offset="0%" style="stop-color:#fff1f2" /><stop offset="60%" style="stop-color:#fecdd3" /><stop offset="100%" style="stop-color:#fca5a5" /></radialGradient></defs>
                <g transform="translate(60, 55)">
                    <path d="M60 0 C 0 5, 0 100, 60 140 C 120 100, 120 5, 60 0" fill="url(#gradK)" stroke="#f43f5e" stroke-width="5"/>
                    <circle cx="40" cy="50" r="6" fill="#1e293b"/><circle cx="80" cy="50" r="6" fill="#1e293b"/>
                    <circle cx="25" cy="65" r="10" fill="#f43f5e" opacity="0.2"/><circle cx="95" cy="65" r="10" fill="#f43f5e" opacity="0.2"/>
                    <path d="M52 75 Q 60 85, 68 75" fill="none" stroke="#1e293b" stroke-width="4" stroke-linecap="round"/>
                    <g class="hand-wave"><path d="M115 50 Q 140 20, 135 60" fill="none" stroke="#f43f5e" stroke-width="10" stroke-linecap="round"/></g>
                </g>
            </svg>`,
            kidney_unit: `<svg viewBox="0 0 200 200" class="w-48 h-48"><g transform="translate(75, 75)"><path d="M25 0 C 0 5, 0 45, 25 60 C 50 45, 50 5, 25 0" fill="#fca5a5" stroke="#f43f5e" stroke-width="4"/><circle cx="15" cy="15" r="2" fill="#1e293b"/><circle cx="35" cy="15" r="2" fill="#1e293b"/></g></svg>`,
            water_drop: `<svg viewBox="0 0 200 200" class="w-48 h-48"><path d="M100 40 Q 65 100, 65 140 A 35 35 0 0 0 135 140 Q 135 100, 100 40" fill="#bae6fd" stroke="#0ea5e9" stroke-width="4"/></svg>`,
            meal_plate: `<svg viewBox="0 0 200 200" class="w-48 h-48"><circle cx="100" cy="100" r="75" fill="#ffffff" stroke="#f1f5f9" stroke-width="8"/><g transform="translate(65, 75)"><circle cx="20" cy="20" r="20" fill="#86efac" opacity="0.9"/><rect x="45" y="10" width="35" height="25" rx="8" fill="#fef08a" opacity="0.9"/><path d="M30 55 Q 60 70, 85 45" fill="#fecaca" stroke="#fca5a5" stroke-width="12" stroke-linecap="round"/></g></svg>`,
            vessel_arm: `<svg viewBox="0 0 200 200" class="w-48 h-48"><path d="M40 145 Q 60 85, 145 115" fill="none" stroke="#ffe4e6" stroke-width="45" stroke-linecap="round"/><path d="M68 122 H 138" stroke="#7dd3fc" stroke-width="15" stroke-linecap="round" opacity="0.8"/></svg>`,
            wrong_cross: `<svg viewBox="0 0 200 200" class="w-56 h-56"><circle cx="100" cy="100" r="70" fill="none" stroke="#fecaca" stroke-width="15"/><path d="M70 70 L130 130 M130 70 L70 130" stroke="#ef4444" stroke-width="15" stroke-linecap="round"/></svg>`
        };

        const markers = [
            { bg: '#e0f2fe', color: '#0369a1', label: 'A' },
            { bg: '#fce7f3', color: '#be185d', label: 'B' },
            { bg: '#fef3c7', color: '#b45309', label: 'C' }
        ];

        const state = {
            view: 'start', category: null, questionIdx: 0, score: 0, audioUnlocked: false,
            quizRepo: {
                ckd: { title: "èªè­˜è…è‡Ÿ", questions: [
                    { q: "ç™¼ç¾å°¿æ¶²æ³¡æ³¡å¤§é‡ä¸”éå¥½ä¹…éƒ½æ•£ä¸æ‰ï¼Œä»£è¡¨ï¼Ÿ", a: ["æ°´åˆ†å–ä¸è¶³çš„æ­£å¸¸æ°£æ³¡", "å¯èƒ½æœ‰è›‹ç™½å°¿çš„è­¦è¨Š", "æ’å°¿é€Ÿåº¦å¤ªå¿«å°è‡´"], correct: 1, tts: "ç¬¬ä¸€é¡Œä¾†å›‰ï¼å¦‚æœæ‚¨ç™¼ç¾é¦¬æ¡¶è£¡çš„æ³¡æ³¡éäº†å¥½ä¹…éƒ½æ•£ä¸æ‰ï¼Œæ‚¨è¦ºå¾—ä»£è¡¨ä»€éº¼æ„æ€å‘¢ï¼Ÿ", exp: "æ³¡æ³¡æ•£ä¸æ‰é€šå¸¸æ˜¯è›‹ç™½å°¿çš„è­¦è¨Šã€‚é€™ä»£è¡¨è…è‡Ÿå±éšœå—æäº†ï¼Œå»ºè­°è¶•å¿«æ‰¾å°ˆæ¥­é†«å¸«æª¢æŸ¥ã€‚" },
                    { q: "æŒ‰å£“è…³è¸æ°´è…«ç•™ä¸‹å‡¹æ´ä¸å½ˆå›ï¼Œæ‡‰è©²è¦å°±é†«å—ï¼Ÿ", a: ["è¦ï¼Œæ’æ°´åŠŸèƒ½å‡ºå•é¡Œäº†", "ä¸ç”¨ï¼Œåªæ˜¯æœ€è¿‘æ¯”è¼ƒç´¯", "å¤šèµ°èµ°è·¯å°±æœƒæ¢å¾©"], correct: 0, tts: "è…³è…«è…«çš„æŒ‰ä¸‹å»æœƒç•™ä¸‹å‡¹ç—•ä¸å½ˆå›ä¾†ï¼Œæ‚¨è¦ºå¾—æ‡‰è©²è¦çœ‹é†«ç”Ÿå—ï¼Ÿ", exp: "æŒ‰å£“ä¸å›å½ˆæ˜¯å…¸å‹æ°´è…«ç‰¹å¾µï¼Œä»£è¡¨æ’æ°´åŠŸèƒ½å—æã€‚ä¸€å®šè¦æ‰¾é†«å¸«æª¢æŸ¥å–”ï¼" },
                    { q: "èº«é«”ç–¼ç—›æ™‚ï¼Œå¯ä»¥éš¨ä¾¿å»è—¥å±€è²·æ­¢ç—›è—¥åƒå—ï¼Ÿ", a: ["å¯ä»¥ï¼Œæ­¢ç—›å°±å¥½", "ä¸å¯ä»¥ï¼Œæˆè—¥å¯èƒ½å‚·è…", "é¸æ“‡å¤§å“ç‰Œæ²’é—œä¿‚"], correct: 1, tts: "å¹³å¸¸å¦‚æœèº«é«”ä¸èˆ’æœï¼Œå¯ä»¥ç›´æ¥å»è—¥å±€éš¨ä¾¿è²·æ­¢ç—›è—¥åƒå—ï¼Ÿ", exp: "è¨±å¤šæ­¢ç—›è—¥å…·å‚™è…æ¯’æ€§ã€‚åœ¨æœç”¨ä»»ä½•è—¥ç‰©å‰ï¼Œè«‹å‹™å¿…è«®è©¢æ‚¨çš„é†«å¸«æ‰å®‰å…¨ã€‚" },
                    { q: "é•·æœŸè¡€å£“è¡€ç³–ä¸ç©©å®šï¼Œæœƒå°è…è‡Ÿé€ æˆå‚·å®³å—ï¼Ÿ", a: ["æ²’é¡¯è‘—å½±éŸ¿", "æœƒç›´æ¥ç ´å£è…å¾®è¡€ç®¡", "ä¸çŸ¥é“è€¶"], correct: 1, tts: "å¦‚æœè¡€å£“è·Ÿè¡€ç³–ä¸€ç›´æ§åˆ¶ä¸å¥½ï¼Œæ‚¨è¦ºå¾—è…è‡Ÿæœƒä¸æœƒå£æ‰å‘¢ï¼Ÿ", exp: "é«˜è¡€ç³–èˆ‡é«˜è¡€å£“æœƒæ…¢æ…¢å¼„å£è…è‡Ÿå¾®è¡€ç®¡ã€‚ç©©å®šæ§åˆ¶é€™å…©é …æŒ‡æ¨™å°±æ˜¯è­·è…æœ€å¥½çš„æ–¹å¼ã€‚" },
                    { q: "æª¢é©—å ±å‘Šä¸­çš„è…éæ¿¾åˆ†æ•¸ï¼ˆè¶Šé«˜åˆ†ï¼‰ä»£è¡¨ï¼Ÿ", a: ["è…è‡Ÿé‹ä½œå¾ˆå¥å…¨", "è…è‡Ÿè² è·å¤ªé‡äº†", "ç„¡åƒè€ƒæŒ‡æ¨™"], correct: 0, tts: "æª¢é©—åˆ†æ•¸è¶Šé«˜ï¼Œä»£è¡¨è…åŠŸèƒ½è¶Šå¼·é‚„æ˜¯è¶Šå¼±å‘¢ï¼Ÿ", exp: "éæ¿¾åˆ†æ•¸è¶Šé«˜ï¼Œä»£è¡¨è…è‡Ÿæ¸…é™¤å»¢ç‰©çš„èƒ½åŠ›è¶Šå¼·ã€‚æˆ‘å€‘è¦ä¸€èµ·åŠªåŠ›ç¶­æŒå¥½åˆ†æ•¸ï¼" }
                ]},
                dialysis: { title: "é€æç”Ÿæ´»", questions: [
                    { q: "æ¯æ¬¡æ´—è…æ™‚ï¼Œæ©Ÿå™¨æ˜¯åœ¨å¹«æ‚¨çš„èº«é«”åšä»€éº¼ï¼Ÿ", a: ["æ¨¡æ“¬è…è‡Ÿæ’é™¤å»¢ç‰©æ°´åˆ†", "å¢åŠ è¡€æ¶²ä¸­çš„ç‡Ÿé¤Š", "æ›¿æ›å…¨èº«è€åŒ–è¡€æ¶²"], correct: 0, tts: "å˜¿ï¼æ‚¨è¦ºå¾—æ¯æ¬¡æ´—è…çš„æ™‚å€™ï¼Œæ©Ÿå™¨æ˜¯åœ¨å¹«æ‚¨çš„èº«é«”åšä»€éº¼æœ€é‡è¦çš„å·¥ä½œå‘¢ï¼Ÿ", exp: "æ´—è…æ©Ÿå°±åƒäººå·¥è…è‡Ÿï¼Œå¹«æ‚¨æ’é™¤æ’ä¸æ‰çš„æ¯’ç´ èˆ‡å¤šé¤˜æ°´åˆ†ã€‚è¾›è‹¦æ‚¨å›‰ï¼" },
                    { q: "å…©æ¬¡æ´—è…é–“é«”é‡å¢åŠ ï¼Œå»ºè­°æ§åˆ¶åœ¨åŸé«”é‡çš„ï¼Ÿ", a: ["ä¸è¶…é 5% ä»¥å…§", "ä¸è¶…é 20% ä»¥å…§", "ä¸éœ€è¦æ§åˆ¶"], correct: 0, tts: "å…©æ¬¡é€æä¹‹é–“ï¼Œé«”é‡å¢åŠ æœ€å¥½æ§åˆ¶åœ¨ç™¾åˆ†ä¹‹å¤šå°‘æ¯”è¼ƒå®‰å…¨ï¼Ÿ", exp: "æ°´åˆ†å¢åŠ å¤ªå¤šå°å¿ƒè‡Ÿè² è·å¾ˆå¤§ï¼å‹™å¿…æ§åˆ¶åœ¨ 5% ä»¥å…§ï¼Œé é˜²è¡°ç«­é¢¨éšªã€‚" },
                    { q: "è¿”å®¶å¾Œç™¼ç¾å‚·å£æ»²è¡€ï¼Œæ‚¨çš„ç¬¬ä¸€åæ‡‰æ‡‰è©²æ˜¯ï¼Ÿ", a: ["ç¢ºå¯¦æŒ‰å£“æ­¢è¡€é»ä¸¦è¯çµ¡é†«é™¢", "å…ˆç¡ä¸€è¦ºç­‰æ˜å¤©èªª", "æ‹¿ç†±æ°´æ•·ä¸€ä¸‹"], correct: 0, tts: "å¦‚æœå›å®¶å¾Œç™¼ç¾å‚·å£æ»²è¡€ï¼Œç¬¬ä¸€åæ‡‰è¦åšä»€éº¼å‘¢ï¼Ÿ", exp: "æ»²è¡€ä¸èƒ½å¤§æ„ï¼è«‹ç«‹å³ç”¨æŒ‡è…¹ç”¨åŠ›æŒ‰ä½æ­¢è¡€é»ä¸¦è¯çµ¡é†«é™¢ã€‚çµ•å°ä¸èƒ½å»ç¡è¦ºè§€å¯Ÿå–”ï¼" },
                    { q: "è¦å¾‹çš„ä¸­ä½å¼·åº¦é‹å‹•ï¼ˆå¦‚æ•£æ­¥ï¼‰å°è…å‹æœ‰å¥½è™•å—ï¼Ÿ", a: ["æå‡å¾ªç’°èˆ‡å¿ƒæƒ…æ”¾é¬†", "åªæ˜¯åœ¨æµªè²»é«”åŠ›", "æœƒåŠ é€ŸåŠŸèƒ½æƒ¡åŒ–"], correct: 0, tts: "æ‚¨è¦ºå¾—å¹³å¸¸å»æ•£æ•£æ­¥å‹•ä¸€å‹•ï¼Œå°å¥åº·æœ‰å¹«åŠ©å—ï¼Ÿ", exp: "é©åº¦é‹å‹•èƒ½ä¿ƒé€²è¡€æ¶²å¾ªç’°ï¼Œå°è¡€å£“æ§åˆ¶è·Ÿå¿ƒæƒ…éƒ½å¾ˆå¥½ã€‚ä¸€èµ·å‹•èµ·ä¾†å§ï¼" },
                    { q: "æ›è…¹è†œè—¥æ°´å‰ï¼Œç”¨è‚¥çš‚å¾¹åº•æ¸…æ½”é›™æ‰‹çš„é‡è¦æ€§ï¼Ÿ", a: ["é é˜²ç´°èŒå¼•ç™¼è…¹è†œç‚", "åªæ˜¯ç‚ºäº†ç¾è§€", "ä¸å…·å‚™ç‰¹æ®Šæ„ç¾©"], correct: 0, tts: "æ›´æ›è—¥æ°´å‰ï¼Œä¸€å®šè¦ç”¨è‚¥çš‚æŠŠæ‰‹æ´—å¾—å¾ˆä¹¾æ·¨å—ï¼Ÿé€™å¾ˆé‡è¦å—ï¼Ÿ", exp: "æ¾ˆåº•æ¸…æ½”æ˜¯ä¿è­·æ‚¨çš„ç”Ÿå‘½ç·šï¼é€™èƒ½é˜»æ–·ç´°èŒé€²å…¥è‚šå­ï¼Œæ˜¯ç…§è­·çš„é¦–è¦ä»»å‹™ã€‚" }
                ]},
                diet: { title: "é£²é£ŸæŒ‘æˆ°", questions: [
                    { q: "é¦™è…¸ã€ç«è…¿ç­‰åŠ å·¥é£Ÿå“ï¼Œç‚ºä»€éº¼ä¸å»ºè­°å¸¸åƒï¼Ÿ", a: ["å«æœ‰åŒ–å­¸ç£·ï¼Œå¸æ”¶ç‡æ¥µé«˜", "è›‹ç™½è³ªå¤ªç‡Ÿé¤Šäº†", "æ²’ä»€éº¼ç‰¹åˆ¥å½±éŸ¿"], correct: 0, tts: "æ‚¨çŸ¥é“ç‚ºä»€éº¼ä¸èƒ½å¸¸å¸¸åƒåŠ å·¥é£Ÿå“å—ï¼Ÿå®ƒå°è…è‡Ÿå“ªè£¡ä¸å¥½ï¼Ÿ", exp: "åŠ å·¥é£Ÿå“å«æœ‰å¤§é‡åŒ–å­¸ç£·ï¼Œèº«é«”å¹¾ä¹å…¨éƒ¨å¸æ”¶ï¼é€™æœƒè®“è¡€ç®¡éˆ£åŒ–ã€éª¨é ­è®Šè„†å–”ã€‚" },
                    { q: "ç…®é’èœæ¡å–ä»€éº¼æ­¥é©Ÿï¼Œå¯ä»¥æœ‰æ•ˆé™ä½é‰€é›¢å­ï¼Ÿ", a: ["ç†±æ°´æ±†ç‡™éå¾Œå€’æ‰æ¹¯æ±", "ç›´æ¥å¤§ç«å¿«ç‚’å³å¯", "ç”Ÿåƒæœ€ç‡Ÿé¤Š"], correct: 0, tts: "ç…®é’èœçš„æ™‚å€™ï¼Œæ¡å–ä»€éº¼ç¥•å¯†æ­¥é©Ÿå¯ä»¥æ¿¾æ‰å°å¿ƒè‡Ÿä¸å¥½çš„é‰€å‘¢ï¼Ÿ", exp: "æ­£ç¢ºï¼å…ˆç‡™éã€å€’æ‰æ¹¯æ°´å†ç‚’ï¼Œå¯ä»¥æ¿¾æ‰ä¸€åŠä»¥ä¸Šçš„é‰€ï¼Œå°å¿ƒè‡Ÿæœ€å®‰å…¨äº†ã€‚" },
                    { q: "å¦‚æœæª¢é©—ç™¼ç¾è¡€è‰²ç´ åä½ï¼ˆè²§è¡€ï¼‰ï¼Œåœ˜éšŠå»ºè­°ï¼Ÿ", a: ["åƒç‰›è‚‰è£œéµé…é™ç£·è—¥ç‰‡", "å®Œå…¨ç¦æ­¢è‚‰é¡æ”å–", "åªå–ç‰›è‚‰æ¹¯å°±å¥½"], correct: 0, tts: "å¦‚æœæ‚¨è¡€è‰²ç´ å¤ªä½ã€æ²’åŠ›æ°£ï¼Œè­·ç†å¸«æœƒé¼“å‹µæ‚¨å¤šåƒä»€éº¼è£œéµå—ï¼Ÿ", exp: "ç‰›è‚‰æ˜¯å„ªè³ªéµè³ªä¾†æºï¼åªè¦é…è‘—é™ç£·è—¥ç‰‡ä¸€èµ·åƒï¼Œå°±æ˜¯è£œè¡€çš„æœ€ä½³æ–¹æ¡ˆã€‚" },
                    { q: "æ´—è…çš„æœ‹å‹å¯ä»¥åƒã€Œæ¥Šæ¡ƒã€æˆ–æ¥Šæ¡ƒè£½å“å—ï¼Ÿ", a: ["çµ•å°ç¦æ­¢ï¼Œå«æœ‰è‡´å‘½æ¯’ç´ ", "å°‘é‡å³å¯è§£é¥", "æ˜¯å„ªè³ªæ°´æœ"], correct: 0, tts: "é€™æ˜¯ç”Ÿå‘½å®‰å…¨é¡Œï¼šæ‚¨è¦ºå¾—æ¥Šæ¡ƒé€™ç¨®æ°´æœï¼Œæ´—è…çš„äººå¯ä»¥åƒä¸€é»é»è§£é¥å—ï¼Ÿ", exp: "çµ•å°ã€çµ•å°ä¸å¯ä»¥ï¼æ¥Šæ¡ƒæœ‰è‡´å‘½çš„ç¥ç¶“æ¯’æ€§ï¼Œè…è‡Ÿæ’ä¸æ‰ï¼Œåƒäº†æœƒå¾ˆå±éšªï¼" },
                    { q: "é™ç£·è—¥ç‰‡ï¼ˆç£·çµåˆåŠ‘ï¼‰ä»€éº¼æ™‚å€™æœç”¨æ•ˆæœæœ€å¥½ï¼Ÿ", a: ["é…é£¯ä¸€èµ·åš¼ç¢åä¸‹", "è‚šå­ç©ºç©ºæ™‚æœç”¨", "ç¡å‰ä¸€æ¬¡æœç”¨"], correct: 0, tts: "ç™¼çµ¦æ‚¨çš„é™ç£·è—¥ç‰‡ï¼Œæ‚¨è¦ºå¾—ä»€éº¼æ™‚å€™åƒè—¥æ•ˆæœ€å¼·å‘¢ï¼Ÿ", exp: "é™ç£·è—¥è¦è·Ÿé£Ÿç‰©æ··åœ¨ä¸€èµ·æ‰èƒ½æŠ“èµ°ç£·é›¢å­ï¼è¨˜å¾—ä¸€å®šè¦éš¨é¤åš¼ç¢åƒå–”ã€‚" }
                ]},
                access: { title: "è¡€ç®¡ç…§è­·", questions: [
                    { q: "æ¯å¤©æ‘¸æ‘¸è¡€ç®¡é€šè·¯ï¼ˆç”Ÿå‘½ç·šï¼‰ï¼Œæ„Ÿè¦ºåˆ°ä»€éº¼æ‰é€šæš¢ï¼Ÿ", a: ["å¼·åŠ›çš„æ²™æ²™éœ‡å‹•æ„Ÿ", "æ¶¼æ¶¼æ»‘æ»‘çš„æ„Ÿè¦º", "å®Œå…¨æ²’æ„Ÿè¦º"], correct: 0, tts: "ç‚ºäº†ç¢ºä¿ç”Ÿå‘½ç·šæ˜¯é€šæš¢çš„ï¼Œæ¯å¤©æ‘¸çš„æ™‚å€™è¦æ„Ÿè¦ºåˆ°ä»€éº¼ï¼Ÿ", exp: "ä¸€å®šè¦æœ‰æ˜é¡¯çš„æ²™æ²™éœ‡å‹•æ„Ÿï¼å¦‚æœéœ‡å‹•æ¶ˆå¤±äº†ï¼Œè«‹ä¸€å®šè¦ç«‹åˆ»è¯ç¹«æˆ‘å€‘å–”ã€‚" },
                    { q: "æ´—è…çš„é‚£éš»æ‰‹è‡‚ï¼Œåœ¨ç”Ÿæ´»ä¸Šæ‡‰çµ•å°é¿å…è¡Œç‚ºï¼Ÿ", a: ["é‡è¡€å£“æˆ–å¢Šæ•é ­å£“è‘—ç¡", "æé‡ç‰©é›éŠè‚Œè‚‰", "ä¿æŒå¤–è§€æ¸…æ½”"], correct: 0, tts: "æ‚¨è¦ºå¾—æ´—è…çš„é‚£éš»æ‰‹ï¼Œå¯ä»¥ç•¶æ•é ­å¢Šè‘—é ­ç¡è¦ºå—ï¼Ÿ", exp: "ä¸å¯ä»¥ï¼å£“è¿«æ˜¯è¡€ç®¡çš„å¤§å¿Œã€‚é‚£éš»æ‰‹ä¸èƒ½é‡è¡€å£“ä¹Ÿä¸èƒ½å£“ç¡ï¼Œè¦å¥½å¥½è­·è‘—å®ƒã€‚" },
                    { q: "ç‚ºä»€éº¼åœ¨æ¥å—æ´—è…æ‰“é‡ä¹‹å‰ï¼Œè¦å¾¹åº•æ¸…æ½”æ‰‹è‡‚ï¼Ÿ", a: ["é é˜²ç´°èŒéš¨é‡é€²å…¥è¡€ç®¡", "å–®ç´”ç‚ºäº†ä¹¾æ·¨ç¾è§€", "è®“é‡é ­æ¯”è¼ƒå¥½æ’"], correct: 0, tts: "ç‚ºä»€éº¼åœ¨æ‰“é‡é€æå‰ï¼Œæˆ‘å€‘è¦æ±‚æ‚¨å‹™å¿…ç”¨è‚¥çš‚å¾¹åº•æ¸…æ½”æ•´éš»æ‰‹è‡‚å‘¢ï¼Ÿ", exp: "æ¾ˆåº•æ¸…æ½”èƒ½æŠŠç´°èŒé™åˆ°æœ€ä½ï¼Œé é˜²åš´é‡æ„ŸæŸ“ï¼é€™æ˜¯è­·è¡€ç®¡çš„ç¬¬ä¸€æ­¥ã€‚" },
                    { q: "è¡€ç®¡è™•çš®è†šç˜™ç™¢ï¼Œä¸‹åˆ—è™•ç†æ–¹å¼ä½•è€…æ­£ç¢ºï¼Ÿ", a: ["è¼•æ‹æˆ–å¡—æŠ¹é†«å›‘ä¹³æ¶²", "ç”¨åŠ›æŠ“åˆ°æ­¢ç™¢ç‚ºæ­¢", "æ‹¿ç†±æ°´ç‡™ä¸€ç‡™"], correct: 0, tts: "å¦‚æœè¡€ç®¡å‘¨é‚Šå¥½ç™¢å¥½ç™¢ï¼Œæ‚¨è¦ºå¾—æ¡å–ä»€éº¼æ–¹å¼æ­¢ç™¢æœ€å®‰å…¨ï¼Ÿ", exp: "åƒè¬ä¸èƒ½æŠ“ç ´çš®ï¼æŠ“ç ´äº†ç´°èŒé‘½é€²å»æœƒå¾ˆéº»ç…©ï¼Œè¼•è¼•æ‹æ‰“æˆ–æŠ¹ä¹³æ¶²å°±å¥½ã€‚" },
                    { q: "ç©¿åˆºéƒ¨ä½çš„ç´—å¸ƒå»ºè­°ä½•æ™‚ç§»é™¤æœ€ä¿éšªï¼Ÿ", a: ["ä¿ç•™è‡³éš”æ—¥æ¸…æ™¨æœ€ä¿éšª", "åˆ°å®¶é¦¬ä¸Šæ’•æ‰", "å…©ä¸‰å°æ™‚å°±æ‹†"], correct: 0, tts: "ç‚ºäº†ç¢ºä¿å®Œå…¨æ­¢è¡€ï¼Œæ‚¨è¦ºå¾—ç´—å¸ƒè¦ç•™åˆ°ä»€éº¼æ™‚å€™å†æ‹†æœ€ä¿éšªï¼Ÿ", exp: "å»ºè­°ç•™åˆ°æ˜å¤©æ—©ä¸Šå¤ªé™½å‡ºä¾†å†æ‹†ã€‚é€™èƒ½ç¢ºä¿è¡€å¡Šå®Œå…¨ç©©å›ºï¼Œé é˜²åŠå¤œæ„å¤–å‡ºè¡€ã€‚" }
                ]}
            }
        };

        const render = () => {
            const root = document.getElementById('app-root');
            if(!root) return;
            root.innerHTML = '';
            if (state.view === 'start') renderStart(root);
            else if (state.view === 'menu') renderMenu(root);
            else if (state.view === 'quiz') renderQuiz(root);
            else if (state.view === 'result') renderResult(root);
            window.scrollTo(0, 0);
        };

        const renderStart = (root) => {
            root.innerHTML = `
                <div class="animate-in fade-in duration-700 text-center">
                    <div class="mb-4">${illustrations.kidney_mega}</div>
                    <div class="text-left mb-10 px-4">
                        <h1 class="main-headline">æ‚¨å¥½æˆ‘æ˜¯æ‚¨çš„<br><span class="text-rose-500">è…è‡Ÿå°å¹«æ‰‹</span></h1>
                        <p class="sub-headline">æˆ‘å€‘ä¾†ç©å€‹è¼•é¬†çš„å°éŠæˆ²ï¼Œä¸€èµ·ç·´ç¿’æ€éº¼ç…§é¡§è…è‡Ÿå§ï¼æº–å‚™å¥½äº†å—ï¼Ÿ</p>
                    </div>
                    <div class="py-4 mb-12">
                        <button id="unlock-btn" class="btn-speech-red animate-bounce">ğŸ“¢ å•Ÿå‹•èªéŸ³ä¼´è®€</button>
                    </div>
                    <div class="grid grid-cols-1 gap-6 pt-10 text-left px-2 border-t-2 border-white/60">
                        <p class="text-[11px] font-black text-slate-400 text-center mb-1 tracking-widest uppercase font-black">é¸å€‹è§’è‰²å‡ºç™¼æŒ‘æˆ°</p>
                        ${[
                            { p: 'å¥åº·å¤¥ä¼´', i: 'ğŸƒ', c: 'å¤§çœ¾æŒ‘æˆ°' },
                            { p: 'é†«äº‹å°ˆå®¶', i: 'ğŸ“', c: 'å°ˆæ¥­ç²¾æº–' },
                            { p: 'è³‡æ·±æ™ºå‹', i: 'ğŸ§‘â€ğŸ¦³', c: 'è…å‹æ¦œæ¨£' }
                        ].map(item => `
                            <button onclick="pickPersona('${item.p}')" class="w-full bg-white/50 border-2 border-white p-5 rounded-[2.5rem] flex items-center gap-6 group hover:bg-white transition-all shadow-sm">
                                <div class="text-6xl group-hover:scale-110 transition-transform">${item.i}</div>
                                <div class="text-left">
                                    <div class="font-black text-xl text-slate-800">${item.p}</div>
                                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${item.c} â€§ å·²å°±ç·’</div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>`;
            document.getElementById('unlock-btn').onclick = () => {
                state.audioUnlocked = true;
                const dummy = new SpeechSynthesisUtterance(' '); window.speechSynthesis.speak(dummy);
                speakChat("ä¾†å›‰ï¼æˆ‘æ˜¯æ‚¨çš„è…è‡Ÿå°å¹«æ‰‹ã€‚ä»Šå¤©æˆ‘å€‘ä¸èªªæ•™ï¼Œä¾†ç©å€‹è¼•é¬†çš„å°éŠæˆ²ï¼Œçœ‹çœ‹æ€éº¼ç…§é¡§è…è‡Ÿæœ€æ£’ï¼æº–å‚™å¥½äº†å—ï¼Ÿæˆ‘å€‘é¸å€‹è§’è‰²å‡ºç™¼æŒ‘æˆ°å§ï¼");
                document.getElementById('unlock-btn').innerText = "âœ… èªéŸ³ä¼´è®€å·²é–‹å•Ÿ";
                document.getElementById('unlock-btn').classList.add('opacity-40');
            };
        };

        const renderMenu = (root) => {
            const badge = document.getElementById('nav-badge');
            if(badge) badge.classList.add('hidden');
            root.innerHTML = `
                <div class="space-y-12 animate-in slide-in-from-bottom-10 duration-500">
                    <div class="py-4 text-center">
                        <h3 class="text-4xl font-black text-slate-800 tracking-tight">è«‹é¸ä¸€å€‹å–®å…ƒé–‹å§‹ã€‚</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-8 px-2">
                        ${[
                            { id: 'ckd', title: 'èªè­˜è…è‡Ÿ', icon: illustrations.kidney_unit },
                            { id: 'dialysis', title: 'é€æç”Ÿæ´»', icon: illustrations.water_drop },
                            { id: 'diet', title: 'é£²é£ŸæŒ‘æˆ°', icon: illustrations.meal_plate },
                            { id: 'access', title: 'è¡€ç®¡ç…§è­·', icon: illustrations.vessel_arm }
                        ].map(unit => `
                            <button onclick="startQuiz('${unit.id}')" class="menu-grid-btn">
                                <div class="w-24 h-24 flex items-center justify-center scale-150">${unit.icon}</div>
                                <span>${unit.title}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>`;
        };

        const renderQuiz = (root) => {
            const badge = document.getElementById('nav-badge');
            if(badge) badge.classList.remove('hidden');
            const cat = state.quizRepo[state.category];
            const q = cat.questions[state.questionIdx];
            if(q.tts) speakChat(q.tts);
            root.innerHTML = `
                <div id="quiz-container" class="space-y-10 animate-in fade-in py-4">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-[10px] font-black text-rose-500/60 uppercase tracking-[0.2em] font-black">${cat.title} è©•æ¸¬</span>
                        <span class="bg-rose-400 text-white text-[11px] px-3 py-1 rounded-full font-black shadow-sm">ç¬¬ ${state.questionIdx + 1} é¡Œ / 5</span>
                    </div>
                    <div class="px-2">
                        <h3 class="text-3xl font-black text-slate-800 mb-12 leading-snug tracking-tighter">${q.q}</h3>
                        <div class="space-y-6">
                            ${q.a.map((opt, idx) => `
                                <button onclick="checkAnswer(${idx})" class="btn-choice soft-card">
                                    <div class="option-marker" style="background: ${markers[idx].bg}; color: ${markers[idx].color}">${markers[idx].label}</div>
                                    <span class="font-bold text-slate-600 text-xl leading-relaxed">${opt}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        };

        const renderResult = (root) => {
            window.speechSynthesis.cancel();
            const score = state.score;
            root.innerHTML = `
                <div class="text-center space-y-12 animate-in zoom-in px-2">
                    <div class="text-[10rem] mb-6 drop-shadow-2xl">${score >= 3 ? 'ğŸ†' : 'ğŸ’ª'}</div>
                    <h2 class="text-4xl font-black text-slate-800 tracking-tight">${score >= 3 ? 'æŒ‘æˆ°æˆåŠŸï¼å¥½å„ªç§€' : 'è©•æ¸¬çµæŸï¼šå†åŠªåŠ›ä¸€ä¸‹'}</h2>
                    <p class="text-slate-500 font-bold italic text-xl">é€™æ¬¡è©•æ¸¬ç­”å°äº† ${score} é¡Œï¼</p>
                    <div class="soft-card p-10 bg-white/90">
                        <h4 class="text-xs font-black text-slate-400 uppercase mb-8 tracking-widest text-center">æ•¸æ“šæŒæ¡ç¨‹åº¦</h4>
                        <div class="chart-container"><canvas id="analysisChart"></canvas></div>
                    </div>
                    <button onclick="state.view='menu'; render();" class="w-full bg-slate-900 text-white py-6 rounded-[2.5rem] font-black text-2xl shadow-2xl active:scale-95 transition-all">æ›å€‹å–®å…ƒè©¦è©¦ï¼</button>
                </div>`;
            setTimeout(() => initResultChart(score, 5), 100);
            speakChat(score >= 3 ? "å°ˆé¡Œè©•æ¸¬çµæŸã€‚æ‚¨çš„è¡¨ç¾éå¸¸å„ªç§€ï¼é€™ä»½è­·è…æ™ºæ…§è«‹ç¹¼çºŒä¿æŒå–”ã€‚" : "å°ˆé¡Œè©•æ¸¬çµæŸã€‚æ•¸æ“šé¡¯ç¤ºæ‚¨ä»æœ‰å¼·åŒ–ç©ºé–“ï¼Œæˆ‘å€‘ç¨å¾Œå†æ¬¡æŒ‘æˆ°ã€‚");
        };

        window.pickPersona = (p) => { state.persona = p; state.view = 'menu'; render(); speakChat(`è§’è‰²è¨­å®šå®Œæˆã€‚æˆ‘å€‘å‡ºç™¼å§ã€‚`); };
        window.startQuiz = (id) => { state.category = id; state.questionIdx = 0; state.score = 0; state.view = 'quiz'; render(); };
       
        window.checkAnswer = (idx) => {
            const cat = state.quizRepo[state.category];
            const q = cat.questions[state.questionIdx];
            const isCorrect = (idx === q.correct);
            const quizNode = document.getElementById('quiz-container');

            if(!isCorrect) {
                // å¼·åŠ›éœ‡å‹•æ„Ÿï¼šç‰©ç† + è¦–è¦º + é–ƒç´…
                if (navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 300]);
                if (quizNode) quizNode.classList.add('animate-heavy-shake');
                document.body.classList.add('flash-red-bg');
               
                speakChat("é¸éŒ¯äº†ï¼é€™é¡Œè¦æ³¨æ„å–”ã€‚");
                setTimeout(() => {
                    document.body.classList.remove('flash-red-bg');
                    if (quizNode) quizNode.classList.remove('animate-heavy-shake');
                    showExplanationModal(false, q);
                }, 700);
            } else {
                state.score++;
                showExplanationModal(true, q);
            }
        };

        function showExplanationModal(isCorrect, q) {
            const overlay = document.createElement('div');
            overlay.className = "fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-lg p-6 flex items-end sm:items-center justify-center";
            overlay.innerHTML = `
                <div class="bg-white w-full max-w-sm rounded-[3.5rem] p-10 modal-show shadow-2xl border-t-[20px] text-center" style="border-top-color: ${isCorrect ? '#6ee7b7' : '#ef4444'}">
                    <div class="text-7xl mb-6">${isCorrect ? 'âœ¨' : 'ğŸ’–'}</div>
                    <h3 class="text-3xl font-black mb-8 italic tracking-tighter ${isCorrect ? 'text-emerald-600' : 'text-rose-500'}">${isCorrect ? 'åˆ¤æ–·æ­£ç¢ºï¼å¥½å„ªç§€' : 'æé†’ï¼šè¦æ³¨æ„å–”'}</h3>
                    <div class="max-h-[160px] overflow-y-auto text-left mb-10 px-4 font-bold leading-relaxed text-slate-600 text-lg font-black"><p>${q.exp}</p></div>
                    <button onclick="this.parentElement.parentElement.remove(); nextStep();" class="w-full bg-slate-900 text-white py-6 rounded-[2.5rem] font-black text-2xl shadow-xl active:scale-95 transition-all">ç¹¼çºŒæŒ‘æˆ°</button>
                </div>`;
            document.body.appendChild(overlay);
            speakChat((isCorrect ? "ç­”å°å›‰ï¼" : "é›–ç„¶é€™é¡Œé¸éŒ¯äº†ï¼Œä½†æˆ‘å€‘ä¾†è½è½çœ‹å°è®€ã€‚") + q.exp, isCorrect ? 'excited' : 'normal');
        }

        window.nextStep = () => { window.speechSynthesis.cancel(); state.questionIdx++; if(state.questionIdx < 5) render(); else { state.view = 'result'; render(); } };

        function initResultChart(score, total) {
            const ctx = document.getElementById('analysisChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['æŒæ¡', 'å¾…å¼·åŒ–'], datasets: [{ data: [score, total-score], backgroundColor: ['#fb7185', '#f1f5f9'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } }
            });
        }
        render();
    </script>
</body>
</html>